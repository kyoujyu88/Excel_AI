Option Explicit

' =========================================================
'  Excel AI チャットクライアント (省エネ版)
'  確認間隔: 4秒
' =========================================================

Const TIMEOUT_SECONDS As Integer = 120

Sub AskAI()
    Dim ws As Worksheet
    Set ws = ActiveSheet 
    
    Dim question As String
    question = ws.Range("B3").Value
    
    If Trim(question) = "" Then
        MsgBox "質問文を入力してください。", vbExclamation
        Exit Sub
    End If
    
    ' ----------------------------------------------------
    ' ★重要設定：郵便ポスト（共有フォルダ）の場所
    ' ----------------------------------------------------
    Dim boxPath As String
    ' テスト用
    boxPath = ThisWorkbook.Path & "\exchange_box\"
    ' 本番用（例）
    ' boxPath = "\\192.168.1.10\Public\Excel_AI\exchange_box\"
    
    If Dir(boxPath, vbDirectory) = "" Then
        MsgBox "共有フォルダが見つかりません。" & vbCrLf & boxPath, vbCritical
        Exit Sub
    End If

    ' 生存確認（ハートビート）
    Dim statusFile As String
    statusFile = boxPath & "status.txt"
    Dim isAlive As Boolean
    isAlive = False
    
    If Dir(statusFile) <> "" Then
        If DateDiff("s", FileDateTime(statusFile), Now) < 30 Then
            isAlive = True
        End If
    End If
    
    If isAlive = False Then
        ws.Range("B6").Value = "エラー：AIが停止中です。"
        MsgBox "AIサーバー（Python）が起動していません。", vbCritical
        Exit Sub
    End If
    
    ' ID生成 & 送信
    Dim myID As String
    Randomize
    myID = Environ("COMPUTERNAME") & "_" & Format(Now, "yyyymmddhhmmss") & "_" & Int((999 - 100 + 1) * Rnd + 100)
    
    Dim reqFile As String, resFile As String
    reqFile = boxPath & "req_" & myID & ".txt"
    resFile = boxPath & "res_" & myID & ".txt"
    
    Call WriteTextUTF8(reqFile, question)
    
    Application.Cursor = xlWait
    ws.Range("B6").Value = "（送信しました。回答を待っています...）"
    DoEvents
    
    ' 待機ループ
    Dim startTime As Single
    startTime = Timer
    
    Dim response As String
    response = ""
    Dim isTimeout As Boolean
    isTimeout = False
    
    Do
        DoEvents
        
        If Timer - startTime > TIMEOUT_SECONDS Then
            isTimeout = True
            Exit Do
        End If
        
        ' 返信チェック
        If Dir(resFile) <> "" Then
            If FileLen(resFile) > 0 Then
                Application.Wait (Now + TimeValue("0:00:01"))
                response = ReadTextUTF8(resFile)
                If Len(response) > 0 Then
                    On Error Resume Next
                    Kill resFile
                    On Error GoTo 0
                    Exit Do
                End If
            End If
        End If
        
        ' 行列状況の更新
        Dim statusMsg As String
        statusMsg = GetQueueStatus(boxPath, reqFile)
        ws.Range("B6").Value = statusMsg
        
        ' ----------------------------------------------------
        ' ★ここを変更！ 4秒待機（サーバーに優しく）
        ' ----------------------------------------------------
        Application.Wait (Now + TimeValue("0:00:04"))
        
    Loop
    
    Application.Cursor = xlDefault
    
    If isTimeout Then
        ws.Range("B6").Value = "エラー：タイムアウトしました。"
        On Error Resume Next
        Kill reqFile
        On Error GoTo 0
    Else
        ws.Range("B6").Value = response
    End If
    
End Sub

Function GetQueueStatus(folderPath As String, myReqFile As String) As String
    Dim fso As Object
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    If Not fso.FileExists(myReqFile) Then
        GetQueueStatus = "（AIが執筆中です！ まもなく完了...）"
        Exit Function
    End If
    
    Dim folder As Object
    Dim f As Object
    Dim myDate As Date
    Dim totalCount As Integer
    Dim olderCount As Integer
    
    On Error Resume Next
    myDate = fso.GetFile(myReqFile).DateCreated
    If Err.Number <> 0 Then
        GetQueueStatus = "（準備中...）"
        Exit Function
    End If
    On Error GoTo 0
    
    totalCount = 0
    olderCount = 0
    Set folder = fso.GetFolder(folderPath)
    
    For Each f In folder.Files
        If Left(f.Name, 4) = "req_" Then
            totalCount = totalCount + 1
            If f.DateCreated < myDate Then
                olderCount = olderCount + 1
            End If
        End If
    Next
    
    GetQueueStatus = "（現在 " & (olderCount + 1) & " 番目 / 全 " & totalCount & " 人待ち）"
End Function

Sub WriteTextUTF8(filePath As String, textContent As String)
    Dim stream As Object
    Set stream = CreateObject("ADODB.Stream")
    With stream
        .Type = 2
        .Charset = "UTF-8"
        .Open
        .WriteText textContent
        .Position = 0
        .Type = 1
        .Position = 3
        Dim binaryData As Variant
        binaryData = .Read
        .Close
        .Open
        .Write binaryData
        .SaveToFile filePath, 2
        .Close
    End With
End Sub

Function ReadTextUTF8(filePath As String) As String
    Dim stream As Object
    Dim text As String
    Set stream = CreateObject("ADODB.Stream")
    On Error Resume Next
    With stream
        .Type = 2
        .Charset = "UTF-8"
        .Open
        .LoadFromFile filePath
        text = .ReadText
        .Close
    End With
    If Err.Number <> 0 Then text = ""
    On Error GoTo 0
    ReadTextUTF8 = text
End Function
