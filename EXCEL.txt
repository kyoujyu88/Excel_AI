' 設定：待ち時間の最大秒数
Const TIMEOUT_SECONDS As Integer = 120 ' 順番待ちがあるので少し長めに

Sub AskAI()
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Sheets("Sheet1")
    
    Dim question As String
    question = ws.Range("B3").Value
    
    If Trim(question) = "" Then
        MsgBox "質問を入力してください。", vbExclamation
        Exit Sub
    End If
    
    ' ----------------------------------------------------
    ' ★ここが変更点！ 共有フォルダの設定
    ' ----------------------------------------------------
    ' 自分のPCで動かすときは ThisWorkbook.Path でいいですが、
    ' 他の人が使うときは「共有フォルダのパス」を直接書く必要があります。
    ' 例: boxPath = "\\ServerName\Public\Excel_AI\exchange_box\"
    
    Dim boxPath As String
    boxPath = ThisWorkbook.Path & "\exchange_box\"
    ' ↑ここを、実際の共有フォルダのアドレス（\\192.168...等）に書き換えてください
    
    If Dir(boxPath, vbDirectory) = "" Then
        MsgBox "共有フォルダが見つかりません。" & vbCrLf & boxPath, vbCritical
        Exit Sub
    End If
    
    ' ★ユニークIDの生成（PC名 + 時間 + ランダム数字）
    Dim myID As String
    myID = Environ("COMPUTERNAME") & "_" & Format(Now, "yyyymmddhhmmss") & "_" & Int((999 - 100 + 1) * Rnd + 100)
    
    Dim reqFile As String, resFile As String
    reqFile = boxPath & "req_" & myID & ".txt"  ' 自分専用の送信ファイル
    resFile = boxPath & "res_" & myID & ".txt"  ' 自分専用の受信ファイル
    
    ' 質問を書き込む
    Call WriteTextUTF8(reqFile, question)
    
    Application.Cursor = xlWait
    ws.Range("B6").Value = "（AIが順番に考えています...お待ちください）"
    DoEvents
    
    ' 回答を待つ
    Dim startTime As Single
    startTime = Timer
    Dim response As String
    response = ""
    
    Do
        DoEvents
        If Timer - startTime > TIMEOUT_SECONDS Then
            response = "混み合っていて応答がありませんでした。（タイムアウト）"
            ' 残ったリクエストゴミを消しておく
            On Error Resume Next
            Kill reqFile
            On Error GoTo 0
            Exit Do
        End If
        
        ' ★自分のIDがついた返信ファイルだけを探す！
        If Dir(resFile) <> "" Then
            Application.Wait (Now + TimeValue("0:00:01"))
            response = ReadTextUTF8(resFile)
            
            On Error Resume Next
            Kill resFile ' 読み終わったら消す
            On Error GoTo 0
            
            Exit Do
        End If
        Application.Wait (Now + TimeValue("0:00:01") / 2)
    Loop
    
    ws.Range("B6").Value = response
    Application.Cursor = xlDefault
End Sub

' (※ WriteTextUTF8 と ReadTextUTF8 関数は前のままでOKです)
